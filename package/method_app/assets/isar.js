(()=>{var e={643:e=>{e.exports=!1},63:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,o,s;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(o=r;0!=o--;)if(!e(t[o],n[o]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(s=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(o=r;0!=o--;)if(!Object.prototype.hasOwnProperty.call(n,s[o]))return!1;for(o=r;0!=o--;){var i=s[o];if(!e(t[i],n[i]))return!1}return!0}return t!=t&&n!=n}},199:()=>{}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";function e(e,t,n){return new Promise(((r,o)=>{const s=n.length,i=s-1;if(0===s)return r();const a=e.txn.objectStore(t);for(let t=0;t<n.length;t++){const s=a.delete(n[t]);s.onerror=()=>{e.abort(),o(s.error)},t===i&&(s.onsuccess=()=>{r()})}}))}function t(t,n,r,o){return 0===o.length?Promise.resolve([]):new Promise(((s,i)=>{const a=t.txn.objectStore(n).index(r),c=[];for(var l=0;l<o.length;l++){const r=a.getAllKeys(o[l]),u=l===o.length-1;r.onsuccess=()=>{c.push(...r.result),u&&e(t,n,c).then((()=>s(c)),i)},r.onerror=()=>{t.abort(),i(r.error)}}}))}var r,o,s,i,a=n(63),c=n.n(a);!function(e){function t(e,t){return t.properties.some((t=>{const n=e.properties.find((e=>e.name===t.name));return t.type===i.Value&&s.isList(n.type)}))}function n(e){return 1===e.properties.length?e.properties[0].name:e.properties.map((e=>e.name))}e.isIndexMultiEntry=t,e.getKeyPath=n,e.matchesIndex=function(e,r,o){return o.name===r.name&&o.multiEntry===t(e,r)&&o.unique===r.unique&&c()(o.keyPath,n(r))}}(r||(r={})),function(e){e.getStoreName=function(e,t,n){return`_${e}_${t}_${n}`}}(o||(o={})),function(e){e.Bool="Bool",e.Byte="Byte",e.Int="Int",e.Float="Float",e.Long="Long",e.Double="Double",e.DateTime="DateTime",e.String="String",e.Object="Object",e.BoolList="BoolList",e.ByteList="ByteList",e.IntList="IntList",e.FloatList="FloatList",e.LongList="LongList",e.DoubleList="DoubleList",e.DateTimeList="DateTimeList",e.StringList="StringList",e.ObjectList="ObjectList"}(s||(s={})),function(e){e.isList=function(e){return e.endsWith("List")}}(s||(s={})),function(e){e.Value="Value",e.Hash="Hash",e.HashElements="HashElements"}(i||(i={}));class l{constructor(){this.cleared=!1,this.addedObjects=new Map,this.deletedObjectIds=new Set}registerChange(e,t){t?(this.addedObjects.set(e,t),this.deletedObjectIds.delete(e)):(this.deletedObjectIds.add(e),this.addedObjects.delete(e))}registerCleared(){this.addedObjects.clear(),this.deletedObjectIds.clear(),this.cleared=!0}}class u{constructor(){this.collectionWatchers=new Set,this.objectWatchers=new Map,this.queryWatchers=new Set}watchLazy(e){return this.collectionWatchers.add(e),()=>this.collectionWatchers.delete(e)}watchObject(e,t){let n=this.objectWatchers.get(e);return null==n&&(n=new Set,this.objectWatchers.set(e,n)),n.add(t),()=>{n.size<=1?this.objectWatchers.delete(e):n.delete(t)}}watchQueryInternal(e,t,n){const r={callback:n,query:e,lazy:t};return this.queryWatchers.add(r),()=>this.queryWatchers.delete(r)}watchQuery(e,t){return this.watchQueryInternal(e,!1,t)}watchQueryLazy(e,t){return this.watchQueryInternal(e,!0,t)}notify(e,t){if(!e.cleared&&0===e.addedObjects.size&&0===e.deletedObjectIds.size)return;function n(e){if(e.lazy)e.callback();else{const n=t();e.query.findAll(n).then(e.callback)}}for(const e of this.collectionWatchers)e();let r;if(e.cleared||e.deletedObjectIds.size>0)for(const e of this.queryWatchers)n(e);else r=new Set(this.queryWatchers);if(e.cleared)for(const[t,n]of this.objectWatchers)for(let r of n)r(e.addedObjects.get(t));else{for(const t of e.deletedObjectIds){const e=this.objectWatchers.get(t);if(null!=e)for(let t of e)t(void 0)}for(const[t,o]of e.addedObjects){const e=this.objectWatchers.get(t);if(null!=e)for(let t of e)t(o);if(null!=r)for(const e of r)e.query.whereClauseAndFilterMatch(t,o)&&(n(e),r.delete(e))}}}}class d{constructor(e,t,n){this.isar=e,this.txn=t,this.active=!0,this.write=n,n&&(this.changes=new Map)}getChangeSet(e){let t=this.changes.get(e);return null==t&&(t=new l,this.changes.set(e,t)),t}commit(){return new Promise(((e,t)=>{this.active=!1,this.txn.oncomplete=()=>{this.changes&&this.isar.notifyWatchers(this.changes),e()},this.txn.onerror=()=>{t(this.txn.error)},this.txn.commit()}))}abort(){this.active&&(this.active=!1,this.txn.abort())}}Promise.resolve(!1);Promise.resolve(!0);var h=Promise.resolve();function f(e,t){return e||(e=0),new Promise((function(n){return setTimeout((function(){return n(t)}),e)}))}function m(){return Math.random().toString(36).substring(2)}var g=0,p=0;function b(){var e=(new Date).getTime();return e===g?1e3*e+ ++p:(g=e,p=0,1e3*e)}const w={create:function(e){var t={messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),h}catch(e){return Promise.reject(e)}},canBeUsed:function(){if("undefined"==typeof window)return!1;if("function"==typeof BroadcastChannel){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}return!1},type:"native",averageResponseTime:function(){return 150},microSeconds:b};var y=function(){function e(e){this.ttl=e,this.map=new Map,this._to=!1}return e.prototype.has=function(e){return this.map.has(e)},e.prototype.add=function(e){var t=this;this.map.set(e,v()),this._to||(this._to=!0,setTimeout((function(){t._to=!1,function(e){for(var t=v()-e.ttl,n=e.map[Symbol.iterator]();;){var r=n.next().value;if(!r)return;var o=r[0];if(!(r[1]<t))return;e.map.delete(o)}}(t)}),0))},e.prototype.clear=function(){this.map.clear()},e}();function v(){return(new Date).getTime()}function k(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var x="messages",C={durability:"relaxed"};function I(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function S(e){e.commit&&e.commit()}function L(e){e.closed||P(e).then((function(){return f(e.options.idb.fallbackInterval)})).then((function(){return L(e)}))}function P(e){return e.closed?h:e.messagesCallback?function(e,t){var n=e.transaction(x,"readonly",C),r=n.objectStore(x),o=[],s=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var i=r.getAll(s);return new Promise((function(e,t){i.onerror=function(e){return t(e)},i.onsuccess=function(t){e(t.target.result)}}))}return new Promise((function(e,i){var a=function(){try{return s=IDBKeyRange.bound(t+1,1/0),r.openCursor(s)}catch(e){return r.openCursor()}}();a.onerror=function(e){return i(e)},a.onsuccess=function(r){var s=r.target.result;s?s.value.id<t+1?s.continue(t+1):(o.push(s.value),s.continue()):(S(n),e(o))}}))}(e.db,e.lastCursorId).then((function(t){var n=t.filter((function(e){return!!e})).map((function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t})).filter((function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)})).sort((function(e,t){return e.time-t.time}));return n.forEach((function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))})),h})):h}const j={create:function(e,t){return t=k(t),function(e){var t="pubkey.broadcast-channel-0-"+e,n=I().open(t);return n.onupgradeneeded=function(e){e.target.result.createObjectStore(x,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,t){n.onerror=function(e){return t(e)},n.onsuccess=function(){e(n.result)}}))}(e).then((function(n){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:m(),eMIs:new y(2*t.idb.ttl),writeBlockPromise:h,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},L(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,P(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,t,n){var r={uuid:t,time:(new Date).getTime(),data:n},o=e.transaction([x],"readwrite",C);return new Promise((function(e,t){o.oncomplete=function(){return e()},o.onerror=function(e){return t(e)},o.objectStore(x).add(r),S(o)}))}(e.db,e.uuid,t)})).then((function(){0===(0,10,Math.floor(11*Math.random()+0))&&function(e){return(t=e.db,n=e.options.idb.ttl,r=(new Date).getTime()-n,o=t.transaction(x,"readonly",C),s=o.objectStore(x),i=[],new Promise((function(e){s.openCursor().onsuccess=function(t){var n=t.target.result;if(n){var s=n.value;if(!(s.time<r))return S(o),void e(i);i.push(s),n.continue()}else e(i)}}))).then((function(t){return function(e,t){if(e.closed)return Promise.resolve([]);var n=e.db.transaction(x,"readwrite",C).objectStore(x);return Promise.all(t.map((function(e){var t=n.delete(e);return new Promise((function(e){t.onsuccess=function(){return e()}}))})))}(e,t.map((function(e){return e.id})))}));var t,n,r,o,s,i}(e)})),e.writeBlockPromise},canBeUsed:function(){return!!I()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:b};function _(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function N(e){return"pubkey.broadcastChannel-"+e}function B(){var e=_();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(e){return!1}return!0}const M={create:function(e,t){if(t=k(t),!B())throw new Error("BroadcastChannel: localstorage cannot be used");var n=m(),r=new y(t.localstorage.removeTimeout),o={channelName:e,uuid:n,eMIs:r};return o.listener=function(e,t){var s=N(e),i=function(e){var t;e.key===s&&(t=JSON.parse(e.newValue),o.messagesCallback&&t.uuid!==n&&t.token&&!r.has(t.token)&&(t.data.time&&t.data.time<o.messagesCallbackTime||(r.add(t.token),o.messagesCallback(t.data))))};return window.addEventListener("storage",i),i}(e),o},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){f().then((function(){var r=N(e.channelName),o={token:m(),time:(new Date).getTime(),data:t,uuid:e.uuid},s=JSON.stringify(o);_().setItem(r,s);var i=document.createEvent("Event");i.initEvent("storage",!0,!0),i.key=r,i.newValue=s,window.dispatchEvent(i),n()}))}))},canBeUsed:B,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:b};var E=b,O=new Set;const D={create:function(e){var t={name:e,messagesCallback:null};return O.add(t),t},close:function(e){O.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise((function(n){return setTimeout((function(){Array.from(O).filter((function(t){return t.name===e.name})).filter((function(t){return t!==e})).filter((function(e){return!!e.messagesCallback})).forEach((function(e){return e.messagesCallback(t)})),n()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:E};var W=[w,j,M],A=new Set,T=0,K=function(e,t){var n,r,o;this.id=T++,A.add(this),this.name=e,this.options=k(t),this.method=function(e){var t=[].concat(e.methods,W).filter(Boolean);if(e.type){if("simulate"===e.type)return D;var n=t.find((function(t){return t.type===e.type}));if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter((function(e){return"idb"!==e.type})));var r=t.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No useable method found in "+JSON.stringify(W.map((function(e){return e.type}))))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,(o=r=(n=this).method.create(n.name,n.options))&&"function"==typeof o.then?(n._prepP=r,r.then((function(e){n._state=e}))):n._state=r};function R(e,t,n){var r={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:h).then((function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then((function(){return e._uMP.delete(t)})),t}))}function q(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function z(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&q(e)){var t=function(t){e._addEL[t.type].forEach((function(e){var n=e.time-1e5;t.time>=n&&e.fn(t.data)}))},n=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,t,n)})):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function F(e,t,n){e._addEL[t]=e._addEL[t].filter((function(e){return e!==n})),function(e){if(e._iL&&!q(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}K._pubkey=!0,K.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return R(this,"message",e)},postInternal:function(e){return R(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};F(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,z(this,"message",t)):this._onML=null},addEventListener:function(e,t){z(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){F(this,e,this._addEL[e].find((function(e){return e.fn===t})))},close:function(){var e=this;if(!this.closed){A.delete(this),this.closed=!0;var t=this._prepP?this._prepP:h;return this._onML=null,this._addEL.message=[],t.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};var H=n(643),V=n.n(H);const Q={add:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope);else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}}};var J=n(199),U=n.n(J);V()&&U(),new Set;const $="_id";class G{constructor(e,t,n){this.collections=new Map,this.db=e,this.relaxedDurability=t,this.initializeCollections(n),this.eventHandler=e=>{e.data&&"change"===e.data.type&&e.data.instance==this.db.name&&this.notifyWatchers(e.data.changes,!0)},G.bc.addEventListener("message",this.eventHandler)}initializeCollections(e){for(let t of e){const n=e.flatMap((e=>e.name===t.name||null==e.links?[]:e.links.filter((e=>e.target===t.name)).map((t=>o.getStoreName(e.name,t.target,t.name))))),r=new Y(this,t,n);this.collections.set(t.name,r)}}notifyWatchers(e,t=!1){let n;const r=()=>(null==n&&(n=this.beginTxn(!1)),n);for(let[t,n]of e.entries())this.getCollection(t).notify(n,r);if(!t){const t={type:"change",instance:this.db.name,changes:e};G.bc.postMessage(t)}}beginTxn(e){const t=this.db.objectStoreNames,n=e?"readwrite":"readonly",r=this.relaxedDurability?{durability:"relaxed"}:{},o=this.db.transaction(t,n,r);return new d(this,o,e)}getCollection(e){return this.collections.get(e)}close(e=!1){if(G.bc.removeEventListener("message",this.eventHandler),this.db.close(),e){const e=indexedDB.deleteDatabase(this.db.name);return new Promise(((t,n)=>{e.onsuccess=()=>{t()},e.onerror=()=>{n(e.error)}}))}return Promise.resolve()}}G.bc=new K("ISAR_CHANNEL");class X{constructor(e,t,n,r){this.isar=e,this.name=t,this.sourceName=n,this.targetName=r,this.storeName=o.getStoreName(n,r,t)}getLinkEntry(e,t,n){return n&&([e,t]=[t,e]),{a:e,b:t}}static getLinkKeyRange(e){return IDBKeyRange.bound([e,-1/0],[e,1/0])}update(e,t,n,r,o){return 0===r.length&&0===o.length?Promise.resolve():new Promise(((s,i)=>{const a=e.txn.objectStore(this.storeName),c=0===o.length;for(let o=0;o<r.length;o++){let l=r[o];const u=a.add(this.getLinkEntry(n,l,t));c&&o===r.length-1&&(u.onsuccess=()=>{s()}),u.onerror=()=>{e.abort(),i(u.error)}}for(let r=0;r<o.length;r++){let c=o[r];const l=t?[c,n]:[n,c],u=a.delete(l);r===o.length-1&&(u.onsuccess=()=>{s()}),u.onerror=()=>{e.abort(),i(u.error)}}}))}clear(t,n,r){return new Promise(((o,s)=>{const i=t.txn.objectStore(this.storeName);if(r){const r=i.index(X.BacklinkIndex).getAllKeys(n);r.onsuccess=()=>{const n=r.result;if(n.length>0){const r=n.map((e=>e[1]));e(t,this.storeName,r).then(o,s)}else o()},r.onerror=()=>{t.abort(),s(r.error)}}else{const e=i.delete(X.getLinkKeyRange(n));e.onsuccess=()=>{o()},e.onerror=()=>{t.abort(),s(e.error)}}}))}}X.BacklinkIndex="backlink";class Y extends u{constructor(e,t,n){super(),this.indexKeyPaths=new Map,this.isar=e,this.name=t.name,this.uniqueIndexes=null!=t.indexes?t.indexes.filter((e=>e.unique)).map((e=>({name:e.name,accessors:e.properties.map((e=>e.name))}))):[],this.links=null!=t.links?t.links.map((n=>new X(e,n.name,t.name,n.target))):[],this.backlinkStoreNames=n,this.multiEntryIndexes=null!=t.indexes?t.indexes.filter((e=>r.isIndexMultiEntry(t,e))).map((e=>e.name)):[],this.indexKeyPaths=new Map(null!=t.indexes?t.indexes.map((e=>[e.name,e.properties.map((e=>e.name))])):[])}getLink(e){return this.links.find((t=>t.name===e))}getIndexKeyPath(e){return this.indexKeyPaths.get(e)}isMultiEntryIndex(e){return this.multiEntryIndexes.includes(e)}get(e,t){let n=e.txn.objectStore(this.name);return new Promise(((e,r)=>{let o=n.get(t);o.onsuccess=()=>{const n=o.result;n&&(n[$]=t),e(n)},o.onerror=()=>{r(o.error)}}))}getAll(e,t){return new Promise(((n,r)=>{const o=e.txn.objectStore(this.name),s=[];for(let e=0;e<t.length;e++){const i=t[e],a=o.get(i);a.onsuccess=()=>{const e=a.result;e&&(e[$]=i),s.push(e),s.length==t.length&&n(s)},a.onerror=()=>{r(a.error)}}}))}getAllByIndex(e,t,n){return 0===n.length?Promise.resolve([]):(n.sort(indexedDB.cmp),new Promise(((r,o)=>{const s=e.txn.objectStore(this.name),i=[],a=s.index(t).openCursor();a.onsuccess=()=>{const e=a.result;if(e){const t=e.value;(i.length>0||e.key===n[0])&&(t?(t[$]=e.primaryKey,i.push(t)):i.push(void 0)),i.length==n.length?r(i):e.continue(n[i.length])}else r([])},a.onerror=e=>{o(e)}})))}putAll(e,t){let n=e.txn.objectStore(this.name);return new Promise(((r,o)=>{const s=[],i=e.getChangeSet(this.name);for(let a=0;a<t.length;a++){const c=t[a],l=c[$],u=n.put(c);delete c[$],s.push(l),l?(i.registerChange(l,c),a===t.length-1&&(u.onsuccess=()=>{r(s)})):u.onsuccess=()=>{const e=u.result;s[a]=e,i.registerChange(e,c),a===t.length-1&&r(s)},u.onerror=()=>{e.abort(),o(u.error)}}}))}deleteLinks(n,r){if(0===this.links.length&&0===this.backlinkStoreNames.length)return Promise.resolve();const o=this.links.map((t=>e(n,t.storeName,r.map(X.getLinkKeyRange)))),s=this.backlinkStoreNames.map((e=>t(n,e,X.BacklinkIndex,r)));return Promise.all([...o,...s]).then((()=>{}))}deleteAll(t,n){return e(t,this.name,n).then((()=>{const e=t.getChangeSet(this.name);for(let t of n)e.registerChange(t);return this.deleteLinks(t,n)}))}deleteAllByIndex(e,n,r){return t(e,this.name,n,r).then((t=>{const n=e.getChangeSet(this.name);for(let e of t)n.registerChange(e);return this.deleteLinks(e,t).then((()=>t.length))}))}clear(e){return new Promise(((t,n)=>{const r=[this.name,...this.backlinkStoreNames,...this.links.map((e=>e.storeName))];for(let o=0;o<r.length;o++){const s=e.txn.objectStore(this.name).clear();s.onerror=()=>{n(s.error)},o===r.length-1&&(s.onsuccess=()=>{e.getChangeSet(this.name).registerCleared(),t()})}}))}}function Z(e,t,n,r){return new Promise(((o,s)=>{const i=indexedDB.open(e,r);i.onsuccess=()=>{const s=i.result;if(null==r){const r=s.transaction(s.objectStoreNames,"readonly");if(!ee(r,!0,t)){const i=r.db.version+1;return s.close(),void o(Z(e,t,n,i))}}const a=new G(s,n,t);o(a)},i.onupgradeneeded=()=>{ee(i.transaction,!1,t)},i.onerror=()=>{s(i.error)}}))}function ee(e,t,n){const s=[];for(const i of n){s.push(i.name);const n=[];let a;if(e.objectStoreNames.contains(i.name))a=e.objectStore(i.name);else{if(t)return!1;a=e.db.createObjectStore(i.name,{autoIncrement:!0})}if(console.log("HELLO"),console.log(i),null!=i.indexes)for(let e of i.indexes){if(n.push(e.name),a.indexNames.contains(e.name)){const n=a.index(e.name);if(r.matchesIndex(i,e,n))continue;t||a.deleteIndex(e.name)}if(t)return!1;a.createIndex(e.name,r.getKeyPath(e),{unique:e.unique,multiEntry:r.isIndexMultiEntry(i,e)})}if(null!=i.links)for(let n of i.links){const r=o.getStoreName(i.name,n.target,n.name);let a;if(e.objectStoreNames.contains(r))a=e.objectStore(r);else{if(t)return!1;a=e.db.createObjectStore(r,{keyPath:["a","b"],autoIncrement:!1})}if(s.push(r),!c()([...a.indexNames],[X.BacklinkIndex])){if(t)return!1;for(let e of a.indexNames)a.deleteIndex(e);a.createIndex(X.BacklinkIndex,"b")}}for(let e of a.indexNames)if(-1===n.indexOf(e)){if(t)return!1;a.deleteIndex(e)}}for(let n of e.objectStoreNames)if(-1===s.indexOf(n)){if(t)return!1;e.db.deleteObjectStore(n)}return!0}function te(e){return new Promise(((t,n)=>{const r=e.txn.txn.objectStore(e.storeName),o=null!=e.indexName?r.index(e.indexName):r,s=e.indexName&&o.multiEntry,i=o.openCursor(e.range,e.direction);i.onsuccess=()=>{const r=i.result;if(r)if(e.offset)r.advance(e.offset),e.offset=void 0;else{if(s&&!Array.isArray(r.value[o.keyPath]))return void r.continue();e.callback(r.primaryKey,r.value,(function(){r.continue()}),t,n)}else t()},i.onerror=e=>{n(e)}}))}"function"!=typeof IDBTransaction.prototype.commit&&(IDBTransaction.prototype.commit=function(){}),window.openIsar=function(e,t,n){return Z(e,t,n)},window.IsarInstance=G,window.IsarTxn=d,window.IsarCollection=Y,window.IsarQuery=class{constructor(e,t,n,r,o,s,i,a,c){this.collection=e,this.whereClauses=t,this.filter=o,this.sortCmp=s,this.distinctValue=i,this.offset=null!=a?a:0,this.limit=null!=c?c:1/0,this.whereClauseDirection=n?r?"nextunique":"prevunique":r?"next":"prev",0===this.whereClauses.length&&this.whereClauses.push({})}getWhereClauseRange(e){var t;return null!==(t=e.range)&&void 0!==t?t:IDBKeyRange.lowerBound(-1/0)}async findInternal(e,t){const n=this.offset,r=this.sortCmp?1/0:n+t,o=this.sortCmp?void 0:this.distinctValue;let s=[];const i=new Set,a=new Set,c=(e,t,n,c)=>{if(i.has(e))n();else if(i.add(e),!this.filter||this.filter(e,t)){if(o){const e=o(t);if(a.has(e))return void n();a.add(e)}t[$]=e,s.push(t),s.length<r?n():c()}else n()};for(const t of this.whereClauses){if(s.length>=r)break;if("linkName"in t){const n=this.collection.isar.getCollection(t.linkCollection).getLink(t.linkName);await te({txn:e,storeName:n.storeName,indexName:t.backlink?X.BacklinkIndex:void 0,range:X.getLinkKeyRange(t.id),direction:this.whereClauseDirection,callback:(n,r,o,s,i)=>{const a=n[t.backlink?0:1];this.collection.get(e,a).then((e=>{e?c(a,e,o,s):o()})).catch((()=>i()))}})}else{const n=this.getWhereClauseRange(t);await te({txn:e,storeName:this.collection.name,indexName:"indexName"in t?t.indexName:void 0,range:n,direction:this.whereClauseDirection,callback:c})}}if(this.sortCmp){s.sort(this.sortCmp);const e=this.distinctValue;e&&(s=s.filter((t=>{const n=e(t);return!a.has(n)&&(a.add(n),!0)})))}return s.slice(n,n+t)}findFirst(e){return this.findInternal(e,1).then((e=>e.length>0?e[0]:void 0))}findAll(e){var t;return this.findInternal(e,null!==(t=this.limit)&&void 0!==t?t:1/0)}deleteFirst(e){return this.findInternal(e,1).then((t=>0!==t.length&&this.collection.deleteAll(e,[t[0][$]]).then((()=>!0))))}deleteAll(e){return this.findInternal(e,this.limit).then((t=>this.collection.deleteAll(e,t.map((e=>e[$]))).then((()=>t.length))))}min(e,t){return this.findAll(e).then((e=>{let n;for(const r of e){const e=r[t];null!=e&&(null==n||e<n)&&(n=e)}return n}))}max(e,t){return this.findAll(e).then((e=>{let n;for(const r of e){const e=r[t];null!=e&&(null==n||e>n)&&(n=e)}return n}))}sum(e,t){return this.findAll(e).then((e=>{let n=0;for(const r of e){const e=r[t];null!=e&&(n+=e)}return n}))}average(e,t){return this.findAll(e).then((e=>{let n=0,r=0;for(const o of e){const e=o[t];null!=e&&(n+=e,r++)}return n/r}))}count(e){return this.findAll(e).then((e=>e.length))}whereClauseMatches(e,t){for(const n of this.whereClauses){if("linkName"in n)return!0;if("indexName"in n)if(this.collection.isMultiEntryIndex(n.indexName)){const e=t[this.collection.getIndexKeyPath(n.indexName)[0]];for(let t of e)if(this.getWhereClauseRange(n).includes(t))return!0}else{let r=this.collection.getIndexKeyPath(n.indexName).map((n=>n===this.collection.name?e:t[n]));if(1===r.length&&(r=r[0]),this.getWhereClauseRange(n).includes(r))return!0}else if(this.getWhereClauseRange(n).includes(e))return!0}return!1}whereClauseAndFilterMatch(e,t){return!(!this.whereClauseMatches(e,t)||this.filter&&!this.filter(e,t))}},window.IsarLink=X})()})();
//# sourceMappingURL=index.js.map